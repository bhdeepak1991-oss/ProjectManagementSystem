@model IEnumerable<PMS.Features.UserManagement.ViewModels.EmployeeViewModel>

@using Microsoft.AspNetCore.Http
@using PMS.Features.UserManagement.Services
@inject IHttpContextAccessor HttpContextAccessor

@{
	var projectName = HttpContextAccessor.HttpContext?.Session.GetString("selectedProjectName");
	var empDetail = HttpContextAccessor.HttpContext?.Session.GetObject<PMS.Domains.Employee>("employee");

	var name = empDetail?.Name ?? "Super Admin";
	var colorHex = GetProjectColor(name);
	var textColor = GetTextColor(colorHex);
	var colorHexForUrl = colorHex.Replace("#", "");
}

@functions {
	// Generate a consistent color from project name
	string GetProjectColor(string input)
	{
		int hash = input.GetHashCode();
		byte r = (byte)((hash & 0xFF0000) >> 16);
		byte g = (byte)((hash & 0x00FF00) >> 8);
		byte b = (byte)(hash & 0x0000FF);

		// Brighten color
		r = (byte)((r + 200) / 2);
		g = (byte)((g + 200) / 2);
		b = (byte)((b + 200) / 2);

		return $"#{r:X2}{g:X2}{b:X2}";
	}

	// Determine text color (black or white) based on background brightness
	string GetTextColor(string hex)
	{
		hex = hex.Replace("#", "");
		int r = Convert.ToInt32(hex.Substring(0, 2), 16);
		int g = Convert.ToInt32(hex.Substring(2, 2), 16);
		int b = Convert.ToInt32(hex.Substring(4, 2), 16);
		int brightness = (r * 299 + g * 587 + b * 114) / 1000;
		return brightness > 160 ? "#000000" : "#FFFFFF"; // black if bright, else white
	}

}

<div id="myDirectChat" class="box box-warning direct-chat direct-chat-warning">
	<div class="box-header with-border d-flex justify-content-between align-items-center">
		<h3 class="box-title" style="margin: 0; line-height: 34px;">Direct Chat</h3>
		<div class="box-tools" style="display: flex; gap: 10px; align-items: center;">
			<div class="form-group" style="margin: 0;">
				<select id="selectUser" class="form-control">
					<option value="">-- Select Employee --</option>
					@{
						foreach (var data in Model)
						{
							<option value="@data.Name">@data.Name (@data.EmployeeCode)</option>
						}
					}

				</select>
			</div>
		</div>
	</div>


	<div class="box-body">
		<!-- Chat Messages -->
		<div class="direct-chat-messages" style="min-height: 300px; max-height: 300px; overflow-y: auto;">

			<!-- Message Left -->
			<div class="direct-chat-msg">
				<div class='direct-chat-info clearfix'>
					<span class='direct-chat-name pull-left'>Alexander Pierce</span>
					<span class='direct-chat-timestamp pull-right'>23 Jan 2:00 pm</span>
				</div>
				<img class="direct-chat-img" src="https://i.pravatar.cc/100?img=1" alt="User Image" />
				<div class="direct-chat-text">
					Is this template really for free? That's unbelievable!
				</div>
			</div>

			<!-- Message Right -->
			<div class="direct-chat-msg right">
				<div class='direct-chat-info clearfix'>
					<span class='direct-chat-name pull-right'>Sarah Bullock</span>
					<span class='direct-chat-timestamp pull-left'>23 Jan 2:05 pm</span>
				</div>
				<img class="direct-chat-img" src="https://i.pravatar.cc/100?img=3" alt="User Image" />
				<div class="direct-chat-text">
					You better believe it!
				</div>
			</div>

			<!-- Message Left -->
			<div class="direct-chat-msg">
				<div class='direct-chat-info clearfix'>
					<span class='direct-chat-name pull-left'>Alexander Pierce</span>
					<span class='direct-chat-timestamp pull-right'>23 Jan 5:37 pm</span>
				</div>
				<img class="direct-chat-img" src="https://i.pravatar.cc/100?img=1" alt="User Image" />
				<div class="direct-chat-text">
					Working on a great new app. Wanna join?
				</div>
			</div>

		</div>

		<!-- Chat Contacts (Optional) -->
		<div class="direct-chat-contacts">
			<ul class='contacts-list'>
				<li>
					<a href='#'>
						<img class='contacts-list-img' src='https://i.pravatar.cc/100?img=5' />
						<div class='contacts-list-info'>
							<span class='contacts-list-name'>
								Count Dracula
								<small class='contacts-list-date pull-right'>2/28/2015</small>
							</span>
							<span class='contacts-list-msg'>How have you been?</span>
						</div>
					</a>
				</li>
				<!-- Add more contacts as needed -->
			</ul>
		</div>
	</div>

	<!-- Footer Input -->
	<div class="box-footer">
		<div class="input-group">
			<input type="text" name="message" placeholder="Type Message ..." class="form-control" />
			<span class="input-group-btn">
				<button id="sendBtn" type="button" class="btn btn-warning btn-flat">Send</button>
			</span>
		</div>
	</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

<script>
	(function () {
		let chatConnection = null;
		const currentUserId = '@name'; // Injected user ID
		const senderName = '@name'; // Display name

		if (!window.chatSignalRInitialized) {
			window.chatSignalRInitialized = true;

			chatConnection = new signalR.HubConnectionBuilder()
				.withUrl("/chatHub?userId=" + encodeURIComponent(currentUserId))
				.configureLogging(signalR.LogLevel.Information)
				.withAutomaticReconnect() // Auto-reconnect added
				.build();

			// Optional: Set keep-alive (default is 15s)
			chatConnection.serverTimeoutInMilliseconds = 60000; // 60 seconds
			chatConnection.keepAliveIntervalInMilliseconds = 15000; // 15 seconds

			// Handle incoming messages
			chatConnection.on("ReceiveMessage", function (sender, message) {
				const chatBox = document.querySelector(".direct-chat-messages");
				if (!chatBox) return;

				const messageDiv = document.createElement("div");
				messageDiv.classList.add("direct-chat-msg", sender === senderName ? "right" : "");

				messageDiv.innerHTML = `
					<div class='direct-chat-info clearfix'>
						<span class='direct-chat-name ${sender === senderName ? "pull-right" : "pull-left"}'>${sender}</span>
						<span class='direct-chat-timestamp ${sender === senderName ? "pull-left" : "pull-right"}'>${new Date().toLocaleTimeString()}</span>
					</div>
					<img class="direct-chat-img" src="https://i.pravatar.cc/100?u=${encodeURIComponent(sender)}" />
					<div class="direct-chat-text">${message}</div>
				`;

				chatBox.appendChild(messageDiv);
				chatBox.scrollTop = chatBox.scrollHeight;
			});

			// Connection lifecycle logging
			chatConnection.onclose(error => {
				console.warn("⚠️ Chat disconnected", error);
			});
			chatConnection.onreconnected(connectionId => {
				console.log("🔄 Chat reconnected:", connectionId);
			});
			chatConnection.onreconnecting(error => {
				console.log("⏳ Chat reconnecting...", error);
			});

			// Start connection
			chatConnection.start()
				.then(() => console.log("✅ SignalR Chat connected"))
				.catch(err => console.error("❌ SignalR Chat connection failed:", err));
		}

		// Delegate the click event to work with partial views
		document.addEventListener("click", function (e) {
			if (e.target && e.target.classList.contains("btn-flat")) {
				const messageInput = document.querySelector("input[name='message']");
				const message = messageInput?.value.trim();
				const selectedUserId = document.getElementById("selectUser")?.value;

				if (message && selectedUserId && chatConnection) {
					chatConnection.invoke("SendMessageToUser", selectedUserId, message, senderName)
						.then(() => console.log("📨 Message sent"))
						.catch(err => console.error("❌ SendMessage error:", err));
					messageInput.value = "";
				}
			}
		});
	})();
</script>
 


